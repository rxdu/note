{"componentChunkName":"component---node-modules-rocketseat-gatsby-theme-docs-core-src-templates-docs-query-js","path":"/tech-notes/system/raspberrypi/raspberrypi-rt-kernel-usb","result":{"data":{"mdx":{"id":"cb3c91dd-a046-5dca-a807-cd9cbedebecc","excerpt":"After building and replacing the Linux kernel 4.19.y-rt on Raspberry Pi 4B (8G), all the USB ports stopped working. The following shows the fix to this issueâ€¦","fields":{"slug":"/tech-notes/system/raspberrypi/raspberrypi-rt-kernel-usb/"},"frontmatter":{"title":"Fix USB Issue in Kernel 4.19.y-rt for Raspberry Pi","description":"Notes on Raspberry Pi","image":null,"disableTableOfContents":null},"body":"var _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"title\": \"Fix USB Issue in Kernel 4.19.y-rt for Raspberry Pi\",\n  \"description\": \"Notes on Raspberry Pi\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"After building and replacing the Linux kernel 4.19.y-rt on Raspberry Pi 4B (8G), all the USB ports stopped working. The following shows the fix to this issue.\"), mdx(\"h2\", {\n    \"id\": \"update-device-tree\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#update-device-tree\",\n    \"aria-label\": \"update device tree permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Update Device Tree\"), mdx(\"p\", null, \"The device tree file \\\"/arch/arm/boot/dts/bcm2711-rpi-4-b.dts\\\" doesn't include the USB related snippets.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-git\"\n  }, \"--- a/arch/arm/boot/dts/bcm2711-rpi-4-b.dts     2020-12-18 13:20:23.973176269 +0000\\n+++ b/arch/arm/boot/dts/bcm2711-rpi-4-b.dts     2020-12-18 13:20:51.072542212 +0000\\n@@ -2,6 +2,7 @@\\n /dts-v1/;\\n #include \\\"bcm2711.dtsi\\\"\\n #include \\\"bcm2835-rpi.dtsi\\\"\\n+#include \\\"bcm283x-rpi-usb-peripheral.dtsi\\\"\\n \\n #include <dt-bindings/reset/raspberrypi,firmware-reset.h>\\n \\n--- /dev/null   2020-12-15 00:20:37.047999998 +0000\\n+++ a/arch/arm/boot/dts/bcm283x-rpi-usb-peripheral.dtsi 2020-12-18 13:25:45.090219029 +0000\\n@@ -0,0 +1,7 @@\\n+// SPDX-License-Identifier: GPL-2.0\\n+&usb {\\n+       dr_mode = \\\"peripheral\\\";\\n+       g-rx-fifo-size = <256>;\\n+       g-np-tx-fifo-size = <32>;\\n+       g-tx-fifo-size = <256 256 512 512 512 768 768>;\\n+};\\n\")), mdx(\"p\", null, \"There are two changes. The first one simply add a line to include \\\"bcm283x-rpi-usb-peripheral.dtsi\\\" in the \\\"/arch/arm/boot/dts/bcm2711-rpi-4-b.dts\\\". The second one creates the included snippets which was missing in the Linux source tree.\"), mdx(\"h2\", {\n    \"id\": \"change-the-firmware\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#change-the-firmware\",\n    \"aria-label\": \"change the firmware permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Change the Firmware\"), mdx(\"p\", null, \"According to the discussion in \", \"[2]\", \", there seems to be some issues in the default firmware. As suggested, copy the firmware binaries from the Ubuntu distribution. Download the firmware package from \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://launchpad.net/ubuntu/+source/linux-firmware-raspi2/1.20200212-0ubuntu1\"\n  }, \"here\"), \": linux-firmware-raspi2_1.20200212.orig.tar.gz.\"), mdx(\"p\", null, \"Extract the files and copy to \\\"/boot\\\" on the Raspberry Pi. You can backup the existing \\\"\", mdx(\"em\", {\n    parentName: \"p\"\n  }, \".elf\\\" and \\\"\"), \".dat\\\" in case you need to recover late.\"), mdx(\"p\", null, \"After rebooting, the USB ports should work. But do note that it's unknown wether there are any other possible issues not covered by this fix and further investigations are required.\"), mdx(\"h2\", {\n    \"id\": \"reference\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#reference\",\n    \"aria-label\": \"reference permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Reference\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"[1]\", \" \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://github.com/raspberrypi/linux/issues/3976\"\n  }, \"https://github.com/raspberrypi/linux/issues/3976\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"[2]\", \" \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://archlinuxarm.org/forum/viewtopic.php?f=65&t=14734&p=65334#p65334\"\n  }, \"https://archlinuxarm.org/forum/viewtopic.php?f=65&t=14734&p=65334#p65334\"))));\n}\n;\nMDXContent.isMDXComponent = true;","headings":[{"depth":2,"value":"Update Device Tree"},{"depth":2,"value":"Change the Firmware"},{"depth":2,"value":"Reference"}]}},"pageContext":{"slug":"/tech-notes/system/raspberrypi/raspberrypi-rt-kernel-usb/","next":{"label":"Back to Main Page","link":"https://rdu.im"},"repositoryEditUrl":"https://github.com/rxdu/note/tree/main/src/docs/tech-notes/system/raspberrypi/raspberrypi-rt-kernel-usb.mdx","repositoryProvider":"GitHub"}},"staticQueryHashes":["1954253342","2328931024","2501019404","973074209"]}